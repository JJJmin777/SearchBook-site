<link rel="stylesheet" href="/stylesheets/stars.css">

<div class="row">
    <div class="col-md-4">
        <div class="book-datails sticky-top">
            <img src="<%= book.image %>" class="img-thumbnail" alt="<%= book.title %>">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <%= book.title%>
                    </h5>
                    <p class="card-text">
                        <%= book.author%>
                    </p>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item text-muted">
                        <%= book.publisher%>
                    </li>
                    <li class="list-group-item"><a href="<%= book.link %>" target="_blank"
                            class="btn btn-primary mt-3">Buy
                            this book</a>
                    </li>
                    <li class="list-group-item">‚Ç©<%= book.price%>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <% if (currentUser) { %>
            <!-- Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú: Î¶¨Î∑∞ ÏûëÏÑ± Ï∞Ω ÌôúÏÑ±Ìôî -->
            <h2>Leave Your Review</h2>
            <form action="/books/<%=book._id%>/reviews" method="POST" class="mb-3 validated-form" novalidate>
                <fieldset class="rating">
                    <div class="rate">
                        <input id="rate2-star5" type="radio" name="review[rating]" value="5" />
                        <label for="rate2-star5" title="Awesome">5</label>

                        <input id="rate2-star5-half" type="radio" name="review[rating]" value="4.5" />
                        <label class="star-half" for="rate2-star5-half" title="Excellent">4.5</label>

                        <input id="rate2-star4" type="radio" name="review[rating]" value="4" />
                        <label for="rate2-star4" title="Very good">4</label>

                        <input id="rate2-star3-half" type="radio" name="review[rating]" value="3.5" />
                        <label class="star-half" for="rate2-star3-half" title="Good">3.5</label>

                        <input id="rate2-star3" type="radio" name="review[rating]" value="3" />
                        <label for="rate2-star3" title="Satisfactory">3</label>

                        <input id="rate2-star2-half" type="radio" name="review[rating]" value="2.5" />
                        <label class="star-half" for="rate2-star2-half" title="Unsatisfactory">2.5</label>

                        <input id="rate2-star2" type="radio" name="review[rating]" value="2" />
                        <label for="rate2-star2" title="Bad">2</label>

                        <input id="rate2-star1-half" type="radio" name="review[rating]" value="1.5" />
                        <label class="star-half" for="rate2-star1-half" title="Very bad">1.5</label>

                        <input id="rate2-star1" type="radio" name="review[rating]" value="1" />
                        <label for="rate2-star1" title="Awful">1</label>

                        <input id="rate2-star0-half" type="radio" name="review[rating]" value="0.5" />
                        <label class="star-half" for="rate2-star0-half" title="Horrific">0.5</label>
                    </div>
                </fieldset>
                <div class="mb-3">
                    <label class="form-label" for="body">Review Text</label>
                    <textarea class="form-control" name="review[body]" id="body" cols="30" rows="3" required></textarea>
                </div>
                <button class="btn btn-success">Submit</button>
            </form>
            <% } else { %>
                <!-- Î°úÍ∑∏ÏïÑÏõÉ ÏÉÅÌÉú: Î¶¨Î∑∞ ÏûëÏÑ± Ï∞Ω ÎπÑÌôúÏÑ±Ìôî -->
                <h2 class="text-muted">Log in to leave a review</h2>
                <div class="d-flex justify-content-start mb-3">
                    <a href="/login" class="btn btn-primary me-2">Login</a>
                    <a href="/register" class="btn btn-secondary">Register</a>
                </div>
                <fieldset disabled>
                    <form class="validated-form" novalidate>
                        <div class="mb-3">
                            <label class="form-label" for="body">Review Text</label>
                            <textarea class="form-control" id="body" cols="30" rows="3"
                                placeholder="Log in to leave a review" disabled></textarea>
                        </div>
                        <button class="btn btn-success mb-3" disabled>Submit</button>
                    </form>
                </fieldset>
                <% } %>

                    <div class="mb-3">
                        <button class="btn btn-outline-secondary" onclick="sortReviews('likes')">Most Liked</button>
                        <button class="btn btn-outline-secondary" onclick="sortReviews('newest')">Newest First</button>
                    </div>

                    <!-- Í∏∞Ï°¥ Î¶¨Î∑∞ Î™©Î°ù -->
                    <% for (let review of book.reviews) { %>
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <%= review.author.username %>
                                </h5>
                                <p class="card-text">
                                    Rated: <%= review.rating %>/5 ‚≠ê
                                </p>
                                <p class="card-text">
                                    <%= review.body %>
                                </p>
                                <h6 class="card-subtitle mb-2 text-muted">Reviewed on: <%=
                                        review.createdAt.toLocaleDateString() %>
                                </h6>
                                <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº -->
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-primary like-button"
                                        data-review-id="<%= review._id %>">
                                        ‚ù§Ô∏è <span class="like-count">
                                            <%= review.likes %>
                                        </span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2"
                                        onclick="toggleComments('<%= review._id %>')">
                                        üí¨ Comments (<span id="comment-count-<%= review._id %>">
                                            <%= review.comments.length %>
                                        </span>)
                                    </button>
                                </div>

                                
                                <!-- ÎåìÍ∏Ä ÏòÅÏó≠ -->
                                <div id="comments-<%= review._id %>" class="mt-3 d-none">
                                    <% for (let comment of review.comments) { %>
                                        <div class="mb-2">
                                            <strong>
                                                <%= comment.author.username %>:
                                            </strong>
                                            <%= comment.body %>
                                        </div>
                                        <% } %>
                                            <form class="comment-form" data-review-id="<%= review._id %>">
                                                <div class="input-group">
                                                    <input type="text" name="body" class="form-control comment-input"
                                                        placeholder="Add a comment" required>
                                                    <button class="btn btn-primary" type="submit">Submit</button>
                                                </div>
                                            </form>
                                </div>
                                

                                <% if (currentUser && review.author.equals(currentUser)) { %>
                                    <form action="/books/<%=book._id%>/reviews/<%=review._id%>?_method=DELETE"
                                        method="POST" class="mt-3">
                                        <button class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                    <% } %>
                            </div>
                        </div>
                        <% } %>
    </div>

</div>


<script src="/javascripts/reviewComment.js"></script>
<script src="/javascripts/sortreview.js"></script>