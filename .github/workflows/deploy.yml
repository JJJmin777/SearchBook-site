name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… 1. GitHub ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… 2. AWS EC2ì— ë°°í¬í•˜ê¸° ìœ„í•œ SSH ì„¤ì •
      - name: Setup SSH and Deploy
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}   # AWS EC2 í¼ë¸”ë¦­ IP
          EC2_USER: ${{ secrets.EC2_USER }}   # AWS ìœ ì €ëª… (ex: ubuntu, ec2-user)
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}   # GitHub Secretsì— ì €ì¥ëœ SSH í‚¤
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            echo "ğŸš€ ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            # âœ… 3. ë°°í¬ ë””ë ‰í„°ë¦¬ ì´ë™ (ê²½ë¡œ í™•ì¸ í•„ìš”)
            cd /home/$USER/app || exit 1
            echo "ğŸ“‚ ë””ë ‰í† ë¦¬ ì´ë™ ì™„ë£Œ"

            # âœ… 4. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main
            echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

            # âœ… 5. npm íŒ¨í‚¤ì§€ ì„¤ì¹˜
            npm install
            echo "ğŸ“¦ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

            # âœ… 6. .env íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
            if [ ! -f .env ]; then
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
              exit 1
            fi

            # âœ… 7. PM2ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„¤ì¹˜
            if ! command -v pm2 &> /dev/null
            then
                echo "âš™ï¸ pm2ê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. ì„¤ì¹˜ ì¤‘..."
                sudo npm install -g pm2
            fi

            # âœ… 8. PM2 í”„ë¡œì„¸ìŠ¤ ì´ˆê¸°í™” í›„ ì¬ì‹œì‘
            pm2 stop all
            pm2 delete all
            pm2 start server.js --name app --env production
            pm2 save
            pm2 restart app --update-env
            echo "ğŸš€ PM2 í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ë˜ëŠ” ì¬ì‹œì‘ ì™„ë£Œ"

            # âœ… 9. ì„œë²„ ì¬ë¶€íŒ… ì‹œ PM2 ìë™ ì‹¤í–‰ ì„¤ì •
            pm2 save
            pm2 startup | bash
            echo "ğŸ”„ PM2ê°€ ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •ë¨"

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
