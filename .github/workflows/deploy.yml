name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # âœ… 1. GitHub ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… 2. AWS EC2ì— ë°°í¬í•˜ê¸° ìœ„í•œ SSH ì„¤ì •
      - name: Setup SSH and Deploy
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}   # AWS EC2 í¼ë¸”ë¦­ IP
          EC2_USER: ${{ secrets.EC2_USER }}   # AWS ìœ ì €ëª… (ex: ubuntu, ec2-user)
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}   # GitHub Secretsì— ì €ì¥ëœ SSH í‚¤
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            echo "ğŸš€ ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            cd /home/$USER/app || exit 1
            echo "ğŸ“‚ ë””ë ‰í† ë¦¬ ì´ë™ ì™„ë£Œ"

            git pull origin main
            echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

            npm install
            echo "ğŸ“¦ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ"

            # âœ… PM2 ì„¤ì¹˜ í™•ì¸ ë° ì‹¤í–‰
            if ! command -v pm2 &> /dev/null
            then
                echo "âš™ï¸ pm2ê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. ì„¤ì¹˜ ì¤‘..."
                sudo npm install -g pm2
            fi

            # âœ… PM2 í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ (í™˜ê²½ ë³€ìˆ˜ ì ìš©)
            pm2 start server.js --name app || pm2 restart app --update-env
            echo "ğŸš€ PM2 í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ë˜ëŠ” ì¬ì‹œì‘ ì™„ë£Œ"

            pm2 save
            pm2 startup | bash
            echo "ğŸ”„ PM2ê°€ ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •ë¨"

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF
